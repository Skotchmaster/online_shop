# Online Shop


**Цель проекта**  
Продемонстрировать настройку и взаимодействие компонентов полного бэкенд‑стека:
- Аутентификация и авторизация с помощью JWT (access + refresh токены, версия ключей через `kid`)
- Асинхронная обработка бизнес‑событий через Apache Kafka
- Хранение и миграция данных в PostgreSQL с использованием GORM
- Реализация REST API на основе Echo
- Управление созданием и изменением товаров только для админа
- Управление состоянием корзины и оформление заказов
- Поддержка ролей (`user`, `admin`) для разных операций

---

---

## Содержание

1. [Описание проекта](#описание-проекта)
2. [Стек технологий](#стек-технологий)
3. [Структура репозитория](#структура-репозитория)
4. [Установка и запуск](#установка-и-запуск)
5. [Настройка окружения](#настройка-окружения)
6. [API Endpoints](#api-endpoints)
7. [Аутентификация и JWT](#аутентификация-и-jwt)
8. [Kafka-события](#kafka-события)
9. [Работа с базой данных](#работа-с-базой-данных)
10. [Интеграционные тесты](#интеграционные-тесты) 

---

## Описание проекта

Проект представляет собой простую демонстрацию бэкенд-сервиса для интернет-магазина. Включает в себя:

* Регистрацию и аутентификацию пользователей
* Выдачу и проверку JWT (access и refresh токены)
* CRUD-операции над товарами (только для админов)
* Управление корзиной пользователя
* Асинхронную отправку событий в Kafka
* Хранение данных в PostgreSQL через GORM

## Стек технологий

* Язык: Go 1.24
* Веб-фреймворк: [Echo](https://echo.labstack.com/)
* ORM: [GORM](https://gorm.io/) + PostgreSQL
* Аутентификация: JWT (HS256) с ключевым хранилищем для роутинга версий ключей (`kid`)
* Сообщения: Apache Kafka (Confluent Platform)
* Контейнеризация: Docker + Docker Compose
* Логирование: встроенный логгер Echo
* Конфигурация: переменные окружения

## Структура репозитория

```
├── cmd/server                          # Точка входа приложения
├── internal
│   ├── handlers 
│   │   ├── auth.go
│   │   ├── product.go
│   │   └── cart
│   │         ├── cart_handlers.go      # 
│   │         └── cart.helpers.go       # Вспомогательные функции для хэндлеров для корзины
│   ├── config                          # Файл с получением данныех из .env файла
│   ├── models                          # Модели GORM (User, Product, CartItem, RefreshToken)
│   ├── mykafka                         # Обёртка для Kafka-производителя
│   ├── hash                            # Утилиты для хеширования паролей
│   └── service
│       ├── token_helpers               # Функции для работы токен сервисов
│       └── token_service               # Основные функции для работы токенов
├── go.mod
├── go.sum
├── .env
└── README.md               # Этот файл
```

## Установка и запуск

1. **Клонируйте репозиторий**

   ```bash
   git clone https://github.com/Skotchmaster/online_shop.git
   cd online_shop

## Настройка окружения

Переменные окружения, необходимые для работы:

```env
# PostgreSQL
DB_HOST=db
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=root
DB_NAME=online_shop

# Kafka
KAFKA_ADDRESS=kafka:9092

# JWT секреты
ACCESS_SECRET_=yourAccessSecret
REFRESH_SECRET_=yourRefreshSecret

```

## API Endpoints

### Публичные

* **POST /register** — регистрация пользователя
* **POST /login** — логин и выдача `access_token` + `refresh_token`
* **POST /logout** - выход из аккаунта

### Защищённые (JWT Middleware)

#### Товары (только роль `admin`)

* **POST /product** — создать товар
* **PATCH /product/:id** — обновить товар
* **DELETE /product/:id** — удалить товар

#### Корзина (роль `user` или `admin`)

* **GET /product/:id** - посмотреть товар подробнее
* **GET /cart** — получить список товаров в корзине
* **POST /cart** — добавить товар в корзину (body: `{ProductID, Quantity}`)
* **DELETE /cart/:id** — уменьшить количество или удалить товар
* **DELETE /cart/:id?all=true** — удалить все единицы товара из корзины
* **POST /cart/order** — создать заказ
## Аутентификация и JWT

* **Access Token** (HS256, 15 мин по умолчанию)

  * Выдается при `/login`
  * Содержит `sub` (UserID), `role`, `exp`,
* **Refresh Token** (HS256, 7 дней)

  * Содержит `sub`, `exp`, `typ = refresh`
  * Хранится в БД для возможности отзыва


## Kafka-события

При ключевых операциях отправляются события в топик:

* `user_events` - регистрация, вход, выход из аккаунта
* `product_events` — создание, обновление, удаление товаров
* `cart_events` — получение, добавление, удаление в корзине

Формат события — JSON с полями `type`, `UserID`, дополнительными данными.

## Работа с базой данных

* Инициализация через `handlers.InitDB()`
* Модели GORM в `internal/models`
* Автоматическая миграция таблиц при старте

## Интеграционные тесты

В папке `tests/` собраны интеграционные тесты для основных компонентов бэкенда онлайн-магазина.

### Запуск тестов


 В корне репозитория выполните:  
   ```bash
   go test ./tests -v
   ```
   или для всех тестов проекта:  
   ```bash
   go test ./... -v
   ```

### Структура папки `tests/`

- `auth_handlers_test.go` — покрывает регистрацию, логин и логаут (AuthHandler).  
- `cart_handlers_test.go` — тестирует работу с корзиной: добавление, удаление позиций, создание заказа.  
- `prosuct_handlers_test.go` — тестирует работу с продуктами: создаение, обновление и удаление товара

---

## Подробное описание тестов

### `auth_handlers_test.go`

- **TestRegister**: проверяет успешную регистрацию нового пользователя, хеширование пароля и обработку дубликатов (HTTP 400 при повторной регистрации).  
- **TestLogin**: проверяет корректный вход с верными учетными данными (возврат access и refresh токенов) и отказ при неверном пароле (HTTP 401).  
- **TestLogOut**: проверяет корректный выход пользователя, удаление/истечение токенов и возврат сообщения "logged out".

### `cart_handlers_test.go`

- **TestAddToCart**: проверяет добавление товара в корзину через `POST /api/cart`, правильность JSON-ответа (`models.CartItem`) и сохранение в БД.  
- **TestGetCart**: проверяет получение списка товаров из корзины через `GET /api/cart`, валидацию авторизации по `refreshToken` и формат ответа (`[]models.CartItem`).  
- **TestDeleteOneFromCart**: проверяет уменьшение количества товара, передачу параметра `id` через путь и JSON-тело `{quantity, product_id}`; убеждается, что количество в БД уменьшилось.  
- **TestDeleteAllFromCart**: проверяет полное удаление товара из корзины при `quantity = 0` и отсутствие записи в БД.  
- **TestMakeOrder**: проверяет создание заказа из всех позиций корзины через `POST /api/cart/order`, создание записей в таблицах `orders` и `order_items`, корректность подсчета `total` и формирование JSON-ответа (`OrderResponse`).

### `product_handlers_test.go`

- **TestGetProduct**: проверяет получение товара: логин обычного пользователя, вставка тестового продукта в БД, затем `GET /api/product/{id}` → ожидается **200 OK** и полное совпадение всех полей ответа с исходными данными.
- **TestCreateProduct**: проверяет создание товара админом: после успешного логина выполняется `POST /api/product` с корректным JSON; ожидается **201 Created** и тело ответа с новым `ID`.
- **TestPatchProduct**: проверяет частичное обновление: админ создаёт товар, выполняет `PATCH /api/product/{id}` с изменёнными полями; ожидается **200 OK** и ответ с обновлёнными значениями в БД.
- **TestDeleteProduct**: проверяет удаление: админ через `DELETE /api/product/{id}` должен получить **204 No Content**, что обозначает успешное удаление записи.
---

## Тонкости

- Тесты используют in-memory SQLite и AutoMigrate всех моделей (включая `Order` и `OrderItem`), чтобы обеспечить изоляцию от реальной базы.  
- Хендлеры тестируются напрямую через Echo Context и `httptest.NewRequest`, без запуска полноценного HTTP-сервера.  
