# Online Shop

Тестовый проект интернет-магазина на Go с использованием JWT, Docker, Kafka, PostgreSQL. Цель проекта — продемонстрировать настройку полного бэкенд-стека, включая аутентификацию, работу с БД и асинхронные события.

---

---

## Содержание

1. [Описание проекта](#описание-проекта)
2. [Стек технологий](#стек-технологий)
3. [Структура репозитория](#структура-репозитория)
4. [Установка и запуск](#установка-и-запуск)
5. [Настройка окружения](#настройка-окружения)
6. [API Endpoints](#api-endpoints)
7. [Аутентификация и JWT](#аутентификация-и-jwt)
8. [Kafka-события](#kafka-события)
9. [Работа с базой данных](#работа-с-базой-данных)

---

## Описание проекта

Проект представляет собой простую демонстрацию бэкенд-сервиса для интернет-магазина. Включает в себя:

* Регистрацию и аутентификацию пользователей
* Выдачу и проверку JWT (access и refresh токены с версионированием ключей)
* CRUD-операции над товарами (только для админов)
* Управление корзиной пользователя
* Асинхронную отправку событий в Kafka
* Хранение данных в PostgreSQL через GORM
* Запуск в Docker-контейнере и оркестрацию через Docker Compose

## Стек технологий

* Язык: Go 1.24
* Веб-фреймворк: [Echo](https://echo.labstack.com/)
* ORM: [GORM](https://gorm.io/) + PostgreSQL
* Аутентификация: JWT (HS256) с ключевым хранилищем для роутинга версий ключей (`kid`)
* Сообщения: Apache Kafka (Confluent Platform)
* Контейнеризация: Docker + Docker Compose
* Логирование: встроенный логгер Echo
* Конфигурация: переменные окружения

## Структура репозитория

```
├── cmd/server              # Точка входа приложения
├── internal
│   ├── handlers            # HTTP handlers (Auth, Product, Cart)
│   ├── config              # файл с получением данныех из .env файла
│   ├── models              # Модели GORM (User, Product, CartItem, RefreshToken)
│   ├── mykafka             # Обёртка для Kafka-производителя
│   ├── hash                # Утилиты для хеширования паролей
│   └── service
│       ├── token_helpers   # Функции для работы токен сервисов
│       └── token_service   # Основные функции для работы токенов
├── Dockerfile              # Мультистадийная сборка Go-приложения
├── docker-compose.yml      # Сборка и запуск всех сервисов (DB, Kafka, Zookeeper, App)
├── go.mod
├── go.sum
├── .env
└── README.md               # Этот файл
```

## Установка и запуск

1. **Клонируйте репозиторий**

   ```bash
   git clone https://github.com/Skotchmaster/online_shop.git
   cd online_shop

## Настройка окружения

Переменные окружения, необходимые для работы:

```env
# PostgreSQL
DB_HOST=db
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=root
DB_NAME=online_shop

# Kafka
KAFKA_ADDRESS=kafka:9092

# JWT секреты (версия 1)
ACCESS_SECRET_V1=yourAccessSecretV1
REFRESH_SECRET_V1=yourRefreshSecretV1

```

## API Endpoints

### Публичные

* **POST /register** — регистрация пользователя
* **POST /login** — логин и выдача `access_token` + `refresh_token`
* **POST /logout** - выход из аккаунта

### Защищённые (JWT Middleware)

#### Товары (только роль `admin`)

* **POST /product** — создать товар
* **PATCH /product/:id** — обновить товар
* **DELETE /product/:id** — удалить товар

#### Корзина (роль `user` или `admin`)

* **GET /product/:id** - посмотреть товар подробнее
* **GET /cart** — получить список товаров в корзине
* **POST /cart** — добавить товар в корзину (body: `{ProductID, Quantity}`)
* **DELETE /cart/:id** — уменьшить количество или удалить товар
* **DELETE /cart/:id?all=true** — удалить все единицы товара из корзины

## Аутентификация и JWT

* **Access Token** (HS256, 15 мин по умолчанию)

  * Выдается при `/login`
  * Содержит `sub` (UserID), `role`, `exp`,
* **Refresh Token** (HS256, 7 дней)

  * Содержит `sub`, `exp`, `typ = refresh`
  * Хранится в БД для возможности отзыва


## Kafka-события

При ключевых операциях отправляются события в топик:

* `user_registrated` — после успешной регистрации
* `user_loged_in` — после логина
* `product_events` — создание, обновление, удаление товаров
* `cart_events` — получение, добавление, удаление в корзине

Формат события — JSON с полями `type`, `UserID`, дополнительными данными.

## Работа с базой данных

* Инициализация через `handlers.InitDB()`
* Модели GORM в `internal/models`
* Автоматическая миграция таблиц при старте
